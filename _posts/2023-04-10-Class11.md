# 1. OSPF简介

## 定义

开放式最短路径优先OSPF（Open Shortest Path First）是IETF组织开发的一个基于链路状态的内部网关协议（Interior Gateway Protocol）。

- OSPF把自治系统AS（Autonomous System）划分成逻辑意义上的一个或多个区域；
- OSPF通过链路状态通告LSA（Link State Advertisement）的形式发布路由；
- OSPF依靠在OSPF区域内各设备间交互OSPF报文来达到路由信息的统一；
- OSPF报文封装在IP报文内，可以采用单播或组播的形式发送。

目前针对IPv4协议使用的是OSPF Version 2（RFC2328）；针对IPv6协议使用OSPF Version 3（RFC2740）。如无特殊说明，本文中所指的OSPF均为OSPF Version 2。

## 优点

在OSPF出现前，RIP是网络上使用最广泛的IGP协议。但随着网络的快速成长和扩展，RIP的某些限制可能会导致其在大型网络中不再适用，OSPF则能够解决RIP所面临的诸多问题。

## RIP

- 基于距离矢量算法，以跳数作为度量方式，忽略带宽的影响。
- RIP的跳数限制为15个，限制了RIP的网络规模。
- 按照路由通告进行路由更新和选择，路由器不了解整个网络拓扑，容易产生路由环路。
- 收敛速度慢，路由更新会经历一段抑制和垃圾收集期，容易导致路由器之间的路由不一致。
- 不能处理可变长子网掩码（VLSM）。

## OSPF

- 基于链路状态，以链路开销作为度量方式，并把带宽作为参考值，度量方式更科学。
- 没有跳数限制，适用的网络规模更大。
- 每台路由器都能够掌握全网拓扑，通过最短路径优先算法SPF（Shortest Path First）计算路由，不会产生路由环路。
- 收敛速度快，因为路由更新是及时的，并且能够快速传递到整个网络。
- 能够处理VLSM，灵活进行IP地址分配。

此外，OSPF还有以下优点：

- OSPF可以采用组播形式收发报文，这样可以减少对未运行OSPF的路由器的影响。
- OSPF支持无类型域间选路（CIDR）。
- OSPF支持对等价路由进行负载分担。
- OSPF支持报文验证。

# 2. OSPF的特点

在OSPF网络中，每台路由器根据自己周围的网络拓扑结构生成链路状态通告LSA（Link State Advertisement），并通过更新报文将LSA发送给网络中的其它路由器。

RIP交互的是路由。与RIP不同，OSPF交互的是链路状态信息。也就是说，RIP中，路由器的选路依赖于邻居路由器的路由信息，但不管邻居路由器传达的信息是否正确；而OSPF中，路由器的选路是一种“自主行为”，LSA只是一种选路的参考信息。

每台路由器都通过链路状态数据库LSDB(Link State DataBase)掌握全网的拓扑结构。如图1所示，每台路由器都会收集其它路由器发来的LSA，所有的LSA放在一起便组成了链路状态数据库LSDB。LSA是对路由器周围网络拓扑结构的描述，LSDB则是对整个自治系统的网络拓扑结构的描述。路由器将LSDB转换成一张带权的有向图，这张图便是对整个网络拓扑结构的真实反映。在网络拓扑稳定的情况下，各个路由器得到的有向图是完全相同的。

[![ppO1SC8.jpg](https://s1.ax1x.com/2023/04/11/ppO1SC8.jpg)](https://imgse.com/i/ppO1SC8)

< center>图1 通过LSDB掌握全网的拓扑结构< /center>

路由器根据最短路径优先(Shortest Path First)算法计算到达目的网络的路径，而不是根据路由通告来获取路由信息。如图2所示，每台路由器根据有向图，使用SPF算法计算出一棵以自己为根的最短路径树，这棵树给出了到自治系统中各节点的路由。相对于RIP，这种机制极大地提升了路由器的自主选路能力，使得路由器不再依靠路由通告进行选路。

[![ppO1p8S.jpg](https://s1.ax1x.com/2023/04/11/ppO1p8S.jpg)](https://imgse.com/i/ppO1p8S)

< center>图2 根据SPF计算到达目的网络的路径< /center>

总之，LSDB保证路由器能够时刻掌握全网的拓扑机构，SPF算法保证路由器能够迅速计算出到达目的网络的最短路径。

# 3. OSPF运行机制

OSPF的运行机制包括以下5个步骤：

- 交互Hello报文
- 泛洪LSA
- 组建LSDB
- SPF算法计算
- 维护和更新路由表

## 交互Hello报文

##通过交互Hello报文形成邻居关系

如图3所示，路由器运行OSPF协议后，会从所有启动OSPF协议的接口上发送Hello报文。如果两台路由器共享一条公共数据链路，并且能够成功协商各自Hello报文中所指定的某些参数，就能形成邻居关系。

[![ppO1CvQ.jpg](https://s1.ax1x.com/2023/04/11/ppO1CvQ.jpg)](https://imgse.com/i/ppO1CvQ)

## 泛洪LSA

## 通过泛洪LSA通告链路状态信息

形成邻居关系的路由器之间进一步交互LSA形成邻接关系，如图4所示。每台路由器根据自己周围的网络拓扑结构生成LSA，LSA描述了路由器所有的链路、接口、邻居及链路状态等信息，路由器通过交互这些链路信息来了解整个网络的拓扑信息。由于链路的多样性，OSPF协议定义了多种LSA类型。详见OSPF LSA类型。

[![ppO1iuj.jpg](https://s1.ax1x.com/2023/04/11/ppO1iuj.jpg)](https://imgse.com/i/ppO1iuj)

< center>图4 通过泛洪LSA通告链路状态信息< /center>

## 组建LSDB

## 通过组建LSDB形成带权有向图

通过LSA的泛洪，路由器会把收到的LSA汇总记录在LSDB中。最终，所有路由器都会形成同样的LSDB，如图5所示。LSA是对路由器周围网络拓扑结构的描述，而LSDB则是对整个自治系统的网络拓扑结构的描述，LSDB是LSA的汇总。

URL5

< center>图5 通过组建LSDB形成带权有向图< /center>

## SPF算法计算

## 通过SPF算法计算并形成路由

如图6所示，当LSDB同步完成之后，每一台路由器都将以其自身为根，使用SPF算法来计算一个无环路的拓扑图来描述它所知道的到达每一个目的地的最短路径（最小的路径代价）。这个拓扑图就是最短路径树，有了这棵树，路由器就能知道到达自治系统中各个节点的最优路径。

URL6

< center>图6 通过SPF算法计算并形成路由< /center>

## 维护和更新路由表

根据SPF算法得出最短路径树后，每台路由器将计算得出的最短路径加载到OSPF路由表形成指导数据转发的路由表项，并且实时更新，如图7所示。同时，邻居之间交互Hello报文进行保活，维持邻居关系或邻接关系，并且周期性地重传LSA。

URL7

< center>图7 维护和更新路由表< /center>














