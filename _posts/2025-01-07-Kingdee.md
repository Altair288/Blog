---
layout: post
title: Ubuntu 22.04 基于Kubernets集群安装金蝶云星空-旗舰版
date: 2025-01-05
Author: 
categories: 
tags: [Kingdee]
comments: false
toc: true
---


# 安装要求

## 1 账号要求

需要有金蝶云企业账号，并且是客户的管理员角色（只有管理员才能看到对应的企业名称）。
说明：金蝶云企业账号注册地址 企业账号中心-我的企业 (https://account.kdcloud.com/main)。
可参考 https://account.kdcloud.com/helpCenter?id=3515718155284762624 进行注册。

## 2 网络要求

1. 环境可以连接互联网
    安装过程需要能够连接galaxyship.kingdee.com和galaxyship-registry.kingdee.com

2. 节点之间网络能通，以下端口不能占用：
- TCP 端口：2379、 2380、6443、10250、10257、10259
- UDP 端口：8472

## 3 操作系统要求

- Ubuntu 18.04*，20.04，22.04

- CentOS  7.4*，7.5*，7.6*，7.7*，7.8*，7.9*，8.0*，8.1*，8.2*，8.3*，8.4*

- Rocky Linux 8.5，9.0*，9.1*，9.2，9.3，9.3

- RHEL  7.4*，7.5*，7.6*，7.7*，7.8*，7.9*，8.0*，8.1*，8.2*，8.3*，8.4*，8.5*，8.6，8.7*，8.8，8.9，8.10，9.0，9.1*，9.2，9.3

## 4 服务器要求

### 4.1 配置要求

1. 单节点模式(非生产场景)

    CPU: x86-64 4核, 内存:16GB，SSD磁盘200GB

    **注意：当前集群日志、镜像、持久存储都默认在/var/目录下，所以要确保/var/有至少100GB及以上存储空间。**

2. 多节点模式(一个master，1或者N个worker节点)

    每个节点最低配置:

    CPU: x86-64 4核, 内存:16GB，SSD磁盘256GB（根据数据量的大小需要提前规划在些基础上增加）

### 4.2 目录存储空间要求

当前集群日志、镜像、持久存储都默认在/var/目录下，所以要确保/var/有至少200GB及以上存储空间。

关键目录位置:

- /var/lib/kubelet: >30GB
- /var/lib/containerd: > 50GB
- /var/openebs: PV持久存储, 存储数据库等，按需要配置

### 4.3 软件环境要求

- 如果服务器安装了docker ,  请先删除docker

### 4.4 主机名要求

```shell
运行: cat /etc/hostname 查看主机名称
```

- 主机hostname必须以字母开头且必须以字母数字结尾，主机hostname最多包含63个字符且只能包含小写字母、数字以及中划线-

### 4.5 浏览器要求

- Google Chrome        如果使用有兼容性问题，请升级到最新版本。
- Microsoft Edge      如果使用有兼容性问题，请升级到最新版本。
- Safari             如果使用有兼容性问题，请升级到最新版本。
- 不支持IE浏览器

# 环境准备步骤

## 0 安装必要工具及确认防火墙关闭

1. Ubuntu安装Openssh

```shell
sudo apt install openssh-server
```

2. 安装net-tools及curl

```shell
sudo apt install net-tools curl
```

3. 确认防火墙是否关闭

```shell
sudo ufw status
# Status: inactive 表示防火墙未启用
# Status: active 表示防火墙已启用
sudo ufw disable #关闭防火墙
```

## 1 添加galaxyship安装用户

为了便于维护及进行权限的隔离，需要用专有的用户进行安装。如果有多个集群节点，需要在每个节点的机器上都创建此安装用户。

用户要求如下：

1. 用户名为：galaxyship
2. 用户在root组内
3. 用户执行sudo 不需要输入密码。

通过以下脚本进行用户的创建及授权：

#创建用户

```shell
sudo useradd -m galaxyship
```

#添加到root用户组

```shell
sudo usermod -aG root galaxyship
```

#进行sudo免密设置

```shell
sudo bash -c 'echo -e "galaxyship ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers'
```

#将新用户默认的shell改为bash 以避免切换用户的时候报错

```shell
sudo chsh -s /bin/bash galaxyship
```

![pic-1](https://share.altair288.eu.org/easyimage/i/2025/01/07/hgq2ai.png)

## 2 修改galaxyship用户的密码

```shell
sudo passwd galaxyship
```

![pic-2](https://share.altair288.eu.org/easyimage/i/2025/01/07/hhg5dr.png)

## 3 进行ssh登陆设置

需要在哪台服务器（比如安装器所安装的服务器）免密连接到其它的服务器，就在哪台服务器（比如安装器所安装的服务器）上执行以下操作：

1. 切换到安装用户

```shell
sudo su galaxyship
```

![pic-3](https://share.altair288.eu.org/easyimage/i/2025/01/07/i7izgm.png)

2. 生成ssh密钥对

执行以下命令，过程中续回车即可：

```shell
ssh-keygen
```

![pic-4](https://share.altair288.eu.org/easyimage/i/2025/01/07/i7jyow.png)

3. 将密钥对的公钥拷贝到需要免密登陆的服务器上

可通过以下命令进行公钥的拷贝

```shell
ssh-copy-id galaxyship@${集群节点ip}
```

**如果有多个集群节点，需要对每个节点都进行公钥的拷贝。**

**注意：如果执行脚本的机器也作为一个服务节点，需要执行**

```shell
ssh-copy-id galaxyship@127.0.0.1
```

比如命令为：

```shell
ssh-copy-id galaxyship@172.27.94.2
```

![pic-5](https://share.altair288.eu.org/easyimage/i/2025/01/07/i7kb1i.png)

## 4 确认关闭swap分区

执行以下命令，以检查是否是swap分区是否关闭。

```shell
free
```

关闭了swap分区：

![pic-6](https://share.altair288.eu.org/easyimage/i/2025/01/07/i7kuml.png)

未关闭swap分区：

![pic-7](https://share.altair288.eu.org/easyimage/i/2025/01/07/i8yuof.png)

如果显示未关闭swap分区，可以用以下命令进行关闭：

```shell
sudo swapoff -a
```

# 安装器下载

安装kubernetes集群需要提前服务器准备，请查看上面安装要求

## 1. 登陆【安装部署平台】

- 先在金蝶云账号中心注册企业且完成企业认证
- 使用该企业用户信息 登录安装部署平台https://galaxyship.kingdee.com
- 该用户即可查看到企业名称

## 2. 选择需要部署环境的企业

请在列头上选择需要部署环境的企业在选择企业名称时，分两种场景：

![pic-8](https://share.altair288.eu.org/easyimage/i/2025/01/07/ll2y51.png)

   1. 如果是安装客户正式环境（含沙箱环境、正式生产环境），则在选择企业名称时，一定要选择在【企业账号中心】上认证过的企业名称；

   2. 如果是安装实施或机构本地测试类环境（非客户的），则在选择企业名称时，该企业名称在【企业账号中心】没有认证要求。

## 3. 选择要安装的目标环境
- 选择安装环境后，点击下一步。安装环境根据实际需要进行选择。

![pic-9](https://share.altair288.eu.org/easyimage/i/2025/01/07/lmud0u.png)

## 4. 下载集群安装器

1. 安装kubernetes集群和Agent的安装器。

![pic-10](https://share.altair288.eu.org/easyimage/i/2025/01/07/lp5h7g.png)

如果还没有安装kubernetes，则下载此安装器。

安装器下载后，是一个Linux shell脚本，名称为：installk8s.sh

# 安装kubernetes集群

如果还没有安装kubernetes，则在该步骤中利用“安装kubernetes集群和Agent的安装器”进行安装，即执行installk8s.sh。

## 1. 执行安装器

将脚本复制到目标linux服务器上，然后在命令行运行:

```shell
sudo chmod +x ./installk8s.sh
bash ./installk8s.sh
```

![pic-11](https://share.altair288.eu.org/easyimage/i/2025/01/07/lr9ezy.png)

![pic-12](https://share.altair288.eu.org/easyimage/i/2025/01/07/lr9ds9.png)

脚本执行的过程中，会下载kubernetes的相关文件，根据网速的情况，所需要的下载的时间有所区别。
脚本执行完成后，控制台会显示星空旗舰产品安装的访问页面地址。复制到浏览器中进行访问即可。
如果需要在多台机器上布署，**也是选择在其中一台上执行此安装脚本即可**。具体如下：

- 多节点安装示意图：

![pic-13](https://share.altair288.eu.org/easyimage/i/2025/01/07/ls706f.png)

- 单节点安装示意图：

![pic-14](https://share.altair288.eu.org/easyimage/i/2025/01/07/ls76w5.png)

## 2. 访问安装器页面

执行完installk8s.sh后，会启动一个web网站，通过访问此网站来进行星空旗舰产品安装。

![pic-15](https://share.altair288.eu.org/easyimage/i/2025/01/07/ltknbo.png)

## 3. 填写安装用户

![pic-16](https://share.altair288.eu.org/easyimage/i/2025/01/07/ltm12r.png)

## 4. 添加安装节点

![pic-17](https://share.altair288.eu.org/easyimage/i/2025/01/07/ltmdpe.png)

根据安装需要，进行添加不同的节点，并进行相关的节点的信息的填写。

![pic-18](https://share.altair288.eu.org/easyimage/i/2025/01/07/ltmxwk.png)

填写说明：

1. 节点类型：kubernetes的master节点或worker节点；
2. 名称：节点的名称，系统自动生成，不可修改；
3. SSH连接（host）：填写安装节点所在的机器ip；
4. 集群内网IP。
- 如果节点只有一个网卡，这里不需要填写。没有特别安装网卡，一般都只有一个网卡。
- 当节点存在多个网卡时，需要在这里指定要用的网卡IP。在后续安装时，会用上这个IP。需要注意的是，不同节点所填写的IP需要在同一个网段中。
5. 端口：节点上对外提供ssh服务的端口。
**注意，暂时不支持多master节点高可用模式。也就是不能添加两个节点类型为master的节点。**

## 5. 保存配置信息

![pic-19](https://share.altair288.eu.org/easyimage/i/2025/01/07/lwh8zu.png)

## 6. 安装kubernetes集群和Agent

![pic-20](https://share.altair288.eu.org/easyimage/i/2025/01/07/lwhhzx.png)

**注意，安装前请确认是否满足“软件环境要求”章节所提到的要求。**

## 7. 查看安装日志及进度

![pic-21](https://share.altair288.eu.org/easyimage/i/2025/01/07/lwhxzc.png)

![pic-22](https://share.altair288.eu.org/easyimage/i/2025/01/07/lwin1p.png)

# 安装星空旗舰产品

## 1. 确认agent安装状态

回到部署平台: http://galaxyship.kingdee.com ，查看agent连接状态。如果是已连接，则可以点击下一步：

![pic-23](https://share.altair288.eu.org/easyimage/i/2025/01/07/lzljzv.png)

![pic-24](https://share.altair288.eu.org/easyimage/i/2025/01/07/lzunb9.png)

## 2. 进行星空旗舰产品配置

![pic-25](https://share.altair288.eu.org/easyimage/i/2025/01/07/m19v2r.png)

重点需要配置每个一组件（当前只支持高级模式，**如果需要建议只修改标记处**）

- nginx端口配置

![pic-26](https://share.altair288.eu.org/easyimage/i/2025/01/07/m3mjhp.png)

- MC配置服务

![pic-27](https://share.altair288.eu.org/easyimage/i/2025/01/07/m3o08e.png)

- kd-cosmic-migration(数据初始化服务)

![pic-28](https://share.altair288.eu.org/easyimage/i/2025/01/07/m3p4f0.png)

- 配置默认的企业编码和企业名称以及管理员手机号

![pic-29](https://share.altair288.eu.org/easyimage/i/2025/01/07/m4d19f.png)

![pic-30](https://share.altair288.eu.org/easyimage/i/2025/01/07/m4dczt.png)

- kd-cosmic-xk(星空旗舰服务)

![pic-31](https://share.altair288.eu.org/easyimage/i/2025/01/07/m5asz3.png)

![pic-32](https://share.altair288.eu.org/easyimage/i/2025/01/07/m5ax4x.png)

- 根据需要配置fileserver的nfs

![pic-33](https://share.altair288.eu.org/easyimage/i/2025/01/07/m5k72c.png)

- postgresql数据库配置

![pic-34](https://share.altair288.eu.org/easyimage/i/2025/01/07/m5t92v.png)

- 勾选pg库对应的节点

![pic-35](https://share.altair288.eu.org/easyimage/i/2025/01/07/m6i3wn.png)

- 根据需要，配置数据库对外访问的服务端口。默认不对外提供数据库访问服务。

![pic-36](https://share.altair288.eu.org/easyimage/i/2025/01/07/m6icpk.png)

- redis配置

![pic-37](https://share.altair288.eu.org/easyimage/i/2025/01/07/m6i65l.png)

## 3. 进行配置的保存

![pic-38](https://share.altair288.eu.org/easyimage/i/2025/01/07/m7c75b.png)

## 4. 进行产品的安装

![pic-39](https://share.altair288.eu.org/easyimage/i/2025/01/07/m7cit3.png)

![pic-40](https://share.altair288.eu.org/easyimage/i/2025/01/07/m7ljcs.png)

## 5. 安装资源、事件、日志查看

如果安装过程中有失败，需要查询相关的事件、日志的信息，以确定失败的原因。

![pic-41](https://share.altair288.eu.org/easyimage/i/2025/01/07/m89gdh.png)

![pic-42](https://share.altair288.eu.org/easyimage/i/2025/01/07/m89v8u.png)

![pic-43](https://share.altair288.eu.org/easyimage/i/2025/01/07/m8ve5m.png)

## 6. mc和erp的访问

直接通过ip的访问

1. 星空旗舰产品

    网址为：http:// $ {ip}:31101/

    账号为：administrator/Kdxk#admin001

2. MC

    网址为：http:// ${ip}:31102/

    账号为：admin/Kdadmin001

**其中，${ip}为安装的服务器节点中的一个节点的ip。**