---
layout: post
title: Nginxçš„locationä¸proxy_passæŒ‡ä»¤è¶…è¯¦ç»†è®²è§£åŠå…¶æœ‰æ— æ–œæ ( / )ç»“å°¾çš„åŒºåˆ«
date: 2024-09-23
Author: 
categories: 
tags: [Nginx]
comments: false
toc: true
---



æœ¬æ–‡æ‰€ä½¿ç”¨çš„ç¯å¢ƒä¿¡æ¯å¦‚ä¸‹ï¼š

- windows11 (ä¸»æœºç³»ç»Ÿ)
- virtual-box-7.0ç¯å¢ƒä¸‹çš„ubuntu-18.04
- nginx-1.22.1 (linux)

# æ–œæ ç»“å°¾ä¹‹äº‰

å®è·µä¸­ï¼Œnginxé‡Œæœ€å¸¸ç”¨çš„æŒ‡ä»¤å°±æ˜¯locationå’Œproxy_passäº†ã€‚å‰è€…ç”¨äºä¸ºä¸åŒè¯·æ±‚uriæŒ‡å®šä¸åŒnginxé…ç½®ï¼Œåè€…ç”¨äºåŒ¹é…çš„locationè¿›è¡Œè½¬å‘ï¼ˆé€šå¸¸æ˜¯åŠ¨æ€å†…å®¹ï¼‰ã€‚å…³äºäºŒè€…çš„é…ç½®ï¼Œæœ‰ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œé‚£ä¾¿æ˜¯ï¼šé…ç½®çš„å€¼æ˜¯å¦æœ‰æ–œæ ç»“å°¾ï¼Œå¯¹æ–‡ä»¶è·¯å¾„æŸ¥æ‰¾ï¼ˆæˆ–è¯·æ±‚è½¬å‘ï¼‰è¡Œä¸ºæœ‰å“ªäº›å½±å“ï¼Ÿç›¸å…³æ–‡ç« ä¹Ÿéå¸¸å¤šï¼Œä¸”å¤šæ•°ç²—çœ‹ä¸€çœ¼ï¼Œç…§å…¶è¡Œäº‹ï¼Œä¹Ÿèƒ½ç«‹å³è§£å†³é—®é¢˜ã€‚é„™äººç§ä»¥ä¸ºå…¶ä¸­éƒ¨åˆ†æ–‡ç« çš„è¯´æ³•æ˜¯ä¸ä¸¥è°¨çš„ï¼Œæ•…ç‰¹æ’°æ­¤æ–‡ï¼Œä»¥å¤‡å·±æŸ¥ã€‚

## ç»“è®º

ä¸å†åºŸè¯ï¼Œç›´æ¥ä¸Šç»“è®ºï¼ˆå¦‚æœå¯¹locationå’Œproxy_passçš„åŠŸèƒ½å’ŒåŸºæœ¬é…ç½®è¿˜ä¸ç†Ÿæ‚‰ï¼Œå»ºè®®å…ˆçœ‹åé¢çš„ç« èŠ‚ï¼‰ï¼š

- location æŒ‡ä»¤æœ‰æ–œæ  / ç»“å°¾çš„æƒ…å†µ

    ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œlocation æŒ‡ä»¤ä¸ä¼šå¯¹æ˜¯å¦æœ‰æ–œæ ç»“å°¾è¿™ä¸ªåœºæ™¯åšç‰¹æ®Šå¤„ç†ï¼Œé™¤éæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

    - locationæŒ‡ä»¤é…ç½®ä¸ºå‰ç¼€åŒ¹é…
    - å‰ç¼€çš„æœ€åä¸€ä¸ªå­—ç¬¦ä¸ºæ–œæ  /
    - æŒ‡ä»¤å†…åµŒå…¥äº†å…¶å®ƒä»£ç†ç±»æŒ‡ä»¤
    - è¿™äº›ä»£ç†ç±»æŒ‡ä»¤æœ‰ï¼šproxy_passã€fastcgi_passã€uwsgi_passã€scgi_passã€memcached_passã€grpc_pass â‘ 
    
    æ»¡è¶³ä»¥ä¸Šæ¡ä»¶åï¼Œä¹Ÿåªä¼šå¯¹ä¸€ä¸ªç‰¹å®šçš„ uri åšç‰¹æ®Šå¤„ç†ï¼Œè¿™ä¸ª uri é™¤äº†æ²¡æœ‰å°¾éƒ¨çš„æ–œæ å¤–ï¼Œæ­£å¥½ä¸ location å®šä¹‰çš„å‰ç¼€ä¸€æ¨¡ä¸€æ ·ã€‚å¯¹è¿™ä¸ªç‰¹æ®Šçš„uriçš„å¤„ç†æ–¹å¼ä¸ºï¼šè¿”å›ä¸€ä¸ª301é‡å®šå‘ï¼Œé‡å®šå‘çš„åœ°å€ä¸ºï¼šåŸå§‹è¯·æ±‚ uri + /ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé‡å®šå‘åœ°å€ä¸ location çš„å‰ç¼€å†…å®¹å®Œå…¨ç›¸åŒ â‘¡

ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š

```nginx
location /films/nature/ { 
    proxy_pass http://film-server;
}
```

å‡å®šè¯·æ±‚çš„ url ä¸º http://localhost/films/natureï¼Œåˆ™ location çš„å¤„ç†æ–¹å¼ä¸ºï¼šè¿”å›ä¸€ä¸ª301é‡å®šå‘ï¼Œé‡å®šå‘çš„åœ°å€ä¸º http://localhost/films/naure/ã€‚ä¸åŸå§‹è¯·æ±‚çš„å”¯ä¸€å·®åˆ«å°±æ˜¯ï¼Œæ–°çš„ uri åœ°å€æ¯”åŸæ¥çš„ uri åœ°å€å°¾éƒ¨å¤šäº†ä¸€ä¸ªæ–œæ  / ğŸ˜

æ˜¯çš„ï¼Œä½ æ²¡çœ‹é”™ï¼Œå¯¹ location çš„é…ç½®é‡Œï¼Œå…¶æœ€åä¸€ä¸ªå­—ç¬¦ä¸ºæ–œæ çš„ç‰¹æ®Šå¤„ç†ï¼Œå°±ä»…æ­¤è€Œå·²äº†ã€‚ç”¨å¤§ç™½è¯è®²å°±æ˜¯ï¼šå˜¿ï¼Œå®¢æˆ·ç«¯ä¼™è®¡ï¼Œä½ è¿™å®¶ä¼™ä¸è®²æ­¦å¾·å‘€ï¼Œä½ è¯·æ±‚çš„uriåœ¨æˆ‘ä»¬ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰çœ‹æ¥å°±æ˜¯ä¸€ä¸ªç›®å½•å‘€ï¼Œé‚£ä½ å’‹ä¸åœ¨å°¾éƒ¨åŠ ä¸Šç›®å½•ç¬¦å·ï¼ˆå³ / ï¼‰å‘¢ï¼Ÿå¿µä½ åˆå§‹çŠ¯ï¼Œä»è½»å‘è½ï¼Œæ‰“å›æœ¬æ¬¡è¯·æ±‚ï¼Œå°†æ ¼å¼æ”¹æ­£ç¡®åå†é‡æ–°å‘è¿‡æ¥ï¼ˆå³301é‡å®šå‘ï¼‰ã€‚

ä¸Šé¢è¿™ä¸ªç‰¹æ®Šæ“ä½œï¼Œæœ‰å¾ˆå¤šé™åˆ¶æ¡ä»¶ï¼Œæœ€ç»ˆä¹Ÿåªä½œç”¨äºä¸€ä¸ªç‰¹æ®Šçš„ uri ã€‚å¦‚æœè¯·æ±‚çš„ url ä¸º http://localhost/films/nature/cheetah.mp4ï¼Œå®ƒåŒæ ·ä¸ä¸Šé¢çš„ loation åŒ¹é…ï¼Œä½†ä¸ä¼šå‘èµ·301é‡å®šå‘ã€‚ä½†å¦‚æœæˆ‘ä»¬å°±æ˜¯è¦è®¿é—® http://localhost/films/nature è¿™ä¸ªèµ„æºï¼Œå¹¶è¦æ±‚æœåŠ¡å™¨ä¸è¦è¿”å›é‡å®šå‘ï¼Œè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ç²¾ç¡®åŒ¹é…æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±åƒä¸‹é¢è¿™æ ·é…ç½®ï¼š

```nginx
location /films/nature/ { 
    proxy_pass http://film-server;
}
location = /films/nature {           # é€šè¿‡ç²¾ç¡®åŒ¹é…ï¼Œå¯é¿å…é‡å®šå‘
    proxy_pass http://film-server;
}
```

å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªååˆ†ç‹¬ç‰¹çš„åœºæ™¯å’Œå¤„ç†æ–¹å¼ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå¹¶ä¸”ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸šåŠ¡ä¹Ÿä¸éœ€è¦å¯¹è¿™ä¸ªç‰¹æ®Šçš„åœºæ™¯åšç‰¹åˆ«çš„å¤„ç†ï¼Œå› æ­¤ï¼Œå®Œå…¨å¯ä»¥å¿½ç•¥è¿™ä¸ªç‰¹æ€§çš„å­˜åœ¨ã€‚

> ğŸ ç‰¹åˆ«è¯´æ˜
é€šè¿‡å®æµ‹å‘ç°ï¼ŒlocationæŒ‡ä»¤è¿˜ä¼šå¯¹ä¸€ç±»ç‰¹åˆ«çš„uriåšé‡å®šå‘å¤„ç†ï¼ˆè¿™ä¸ªç‰¹æ€§æ²¡æœ‰åœ¨å®˜æ–¹æ–‡æ¡£ä¸Šæ³¨æ˜ï¼‰ï¼Œè¿™ç±»uriçš„ç‰¹ç‚¹æ˜¯ï¼š

uriæœ€åä¸€ä¸ªå­—ç¬¦ä¸æ˜¯æ–œæ  /

æ•´ä¸ªuriæ­£å¥½æŒ‡å‘locationå†…rootæŒ‡ä»¤ç›®å½•ä¸‹çš„æŸä¸ªå­ç›®å½•

ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä¸€ä¸ªuriåœ¨æœåŠ¡å™¨ç«¯æ­£å¥½æŒ‡å‘äº†ä¸€ä¸ªç›®å½•ï¼Œä½†è¿™ä¸ªuriå´æ²¡æœ‰ä»¥ç›®å½•ç¬¦å·/ç»“å°¾ã€‚

æ¯”å¦‚æœ‰ä¸‹é¢è¿™æ ·ä¸€ä¸ªé…ç½®

```nginx
server {
    listen 80;

    location /books/ {
    root /var/www/book-store;
  }
}
```

å‡å®šæœåŠ¡å™¨ä¸Šæœ‰ /var/www/book-store/books/ å’Œ /var/www/book-store/books/society/ è¿™ä¸¤ä¸ªç›®å½•ï¼Œå½“è®¿é—® http://localhost/books å’Œ http://localhost/books/society æ—¶ï¼Œéƒ½ä¼šè¿”å›301å‘ï¼Œä¸”é‡å®šå‘çš„åœ°å€ä¸º http://localhost/books/ å’Œ  http://localhost/books/society/

è¿™çœ‹ä¸Šå»å¾ˆåˆç†ï¼Œä½†å¦‚æœè¯·æ±‚æ˜¯é€šè¿‡ä»£ç†ç±»æŒ‡ä»¤ï¼ˆå‚è§â‘ å¤„ï¼‰è½¬å‘è¿‡æ¥æ—¶ï¼Œå¾ˆå¯èƒ½å¼•å‘åŸŸåè§£æé—®é¢˜ï¼Œæœ€ç»ˆå¯¼è‡´è®¿é—®ä¸äº†ã€‚å› ä¸ºé‡å®šå‘çš„hostå°±æ˜¯è¯·æ±‚çš„hostï¼Œè¿™åœ¨ç›´æ¥è®¿é—®æ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†å¯¹äºé€šè¿‡ä»£ç†æŒ‡ä»¤è½¬å‘çš„è¯·æ±‚ï¼Œå…¶hostå·²ä¸å†æ˜¯åˆå§‹è¯·æ±‚çš„hostï¼Œé€šå¸¸éƒ½æ˜¯ å†…éƒ¨çš„è™šæ‹Ÿä¸»æœºæˆ–ä¸»æœºç¾¤ç»„(ç”¨äºè´Ÿè½½å‡è¡¡)åç§°ï¼Œè¿™äº›åç§°å¤–éƒ¨æ˜¯ä¸å¯è§£æçš„ï¼Œä»è€Œä¼šåœ¨æœ€åˆçš„è¯·æ±‚å®¢æˆ·ç«¯å¼•å‘åŸŸåè§£æé—®é¢˜ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ä¾‹è¯´æ˜ï¼š

ç¤ºä¾‹é…ç½®å¦‚ä¸‹

```nginx
server { 
    listen 80;
    location /film/ {                 â‘´
        proxy_pass http://film-server;  
    }
}

upstream flim-server {
  server localhost:8379;
}

server {
    listen 8379;
    location / {                      â‘µ
        root /var/www/film-doc;
        index index.html;
    }
}
```

å‡å®šæœåŠ¡å™¨ä¸Šå­˜åœ¨ /var/www/film-doc/film/ å’Œ /var/www/film-doc/film/war/ ä¸¤ä¸ªç›®å½•ï¼Œå½“è®¿é—®http://localhost/film/war æ—¶ï¼Œä¼šåŒ¹é…åˆ°â‘´å¤„ï¼Œç„¶åä¼šå‘èµ·ä»£ç†ï¼Œåœ°å€ä¸ºhttp://film-server/filwarï¼Œè¿™ä¸ªåœ°å€å°†é€šè¿‡ upstream æœ€ç»ˆæ‰§è¡Œåˆ°â‘µå¤„ã€‚ç”±äº   è¿™ä¸ª uri æ­£å¥½å¯¹åº”ç£ç›˜ç›®å½• /var/www/film-doc/film/war/ï¼Œä½†å´æ²¡æœ‰ä»¥ç›®å½•ç¬¦å·/ç»“å°¾ï¼Œå› æ­¤â‘µå¤„çš„è¿™ä¸ªserverå°†è¿”å›ä¸€ä¸ª301é‡å®šå‘å“åº”ã€‚

å¯¹äºâ‘µå¤„çš„è¿™ä¸ª server è€Œè¨€ï¼Œå®ƒæ”¶åˆ°çš„è¯·æ±‚ä¸º http://film-server/film/warï¼Œå…¶ä¸»æœºå film-server å·²ç»ä¸>æ˜¯æœ€åˆçš„ localhost äº†ï¼Œå› æ­¤è¿”å›çš„é‡å®šå‘åœ°å€ä¸º http://film-server/film/war/ã€‚å®¢å†æ¬¡å‘èµ· http://film-server/film/war/æ—¶ï¼Œä¼š    è§£æä¸äº† film-server è¿™ä¸ªä¸»æœºåï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª nginx å†…éƒ¨è™šæ‹Ÿçš„ä¸»æœºç¾¤çš„åå­—ï¼Œæœ€ç»ˆåŸå§‹çš„ http://localhost/film/war è¯·æ±‚ä¼šå¤±è´¥ï¼Œæµè§ˆå™¨ç°ä¸ºæ¥æ”¶ä¸åˆ°ä»»ä½•å“åº”ï¼Œé€šè¿‡F12æ‰“å¼€è°ƒè¯•é¢æ¿ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæµè§ˆå™¨æ”¶åˆ°äº†ä¸€æ¬¡é‡å®šå‘å“åº”ï¼Œå¹¶æ ¹æ®é‡å®šå‘åœ°å€    å†æ¬¡å‘èµ·äº†æ–°çš„è¯·æ±‚ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘èµ· http://localhost/film è¿™ä¸ªè¯·æ±‚ä¼šæ€ä¹ˆæ ·å‘¢ï¼Œä¼šä¸ä¼šä¹Ÿå¤±è´¥å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸ä¼šå¤±è´¥ï¼Œè¿™ä¸ªè¯·æ±‚çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

- è¯·æ±‚åŒ¹é…åˆ°â‘´å¤„ï¼Œå°½ç®¡ /film å¹¶ä¸ä¸ /film/ åŒ¹é…ï¼ˆå°‘äº†æœ«å°¾çš„æ–œæ ï¼‰ï¼Œä½†æ ¹æ®å‰é¢â‘¡å¤„çš„è§„åˆ™ï¼Œå°†è¿”å›301é‡å®šå‘ï¼Œåœ°å€ä¸º http://localhost/film/

- å®¢æˆ·ç«¯æ”¶åˆ°é‡å®šå‘å“åº”åï¼Œå‘èµ·æ–°çš„è¯·æ±‚ï¼Œåœ°å€ä¸º http://localhost/film/

- è¯·æ±‚ä¸â‘´å¤„å®Œå…¨åŒ¹é…ï¼Œå‘èµ·å†…éƒ¨ä»£ç†è¯·æ±‚ï¼Œåœ°å€ä¸º http://film-server/film/

- ä»£ç†è¯·æ±‚ä¸â‘µå¤„åŒ¹é…ï¼Œç”±äºæœåŠ¡å™¨ä¸Šæ­£å¥½å­˜åœ¨ /var/www/film-doc/film/ è¿™ä¸ªç›®å½•ï¼Œä¸”è¯·æ±‚çš„ uri æ˜¯ä»¥ç›®å½•ç¬¦å·/ ç»“å°¾çš„ï¼Œå› æ­¤ä¸ä¼šå†è¿”å›301é‡å®šå‘å“åº”äº†

- æ¥ä¸‹æ¥ä¼šæ£€æŸ¥ /var/www/film-doc/film/ ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨index.htmlæ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ï¼Œæ²¡æœ‰åˆ™è¿”å›403 Forbiddenå“åº”ï¼ˆè¿”å›403æ˜¯é»˜è®¤è¡Œä¸ºï¼Œå¦‚æœ location å†…æ·»åŠ äº†autoindex onæŒ‡ä»¤ï¼Œå³å…è®¸ç›®å½•ï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ªç›®å½•åˆ—è¡¨é¡µé¢ï¼‰ã€‚

proxy_pass æŒ‡ä»¤æœ‰æ–œæ  / ç»“å°¾çš„æƒ…å†µ

proxy_pass æŒ‡ä»¤**ä¸ä¼š**å¯¹å…¶é…ç½®æ˜¯å¦æœ‰æ–œæ ç»“å°¾åšä»»ä½•ç‰¹æ®Šå¤„ç†

æ›´ä¸¥æ ¼è€Œå‡†ç¡®åœ°è¯´æ³•æ˜¯ï¼šproxy_pass æŒ‡ä»¤ä¼šé’ˆå¯¹å…¶é…ç½®æ˜¯å¦åŒ…å«æœ‰ uri ï¼ˆè¿™é‡Œçš„ uri æ˜¯æŒ‡ url ä¸­ï¼Œç«¯å£ä¸é—®å·ä¹‹é—´çš„éƒ¨åˆ†ï¼‰åšç‰¹æ®Šå¤„ç†ï¼Œå…·ä½“å¦‚ä¸‹ â‘¢ ï¼š

ä¸å¸¦uriæ—¶ï¼ˆå¦‚http://localhost:8379ï¼‰
æ–°çš„åœ°å€æ„æˆä¸ºï¼šproxy_passçš„é…ç½®å†…å®¹ + åŸå§‹è¯·æ±‚uriä¸­å»é™¤æ‰åè®®ã€ä¸»æœºå’Œç«¯å£åçš„å‰©ä½™å†…å®¹

é…ç½®äº†uriæ—¶ï¼ˆå¦‚http://localhost:8379/ æˆ–http://localhost:8379/foo ï¼‰
æ–°çš„åœ°å€æ„æˆä¸ºï¼šproxy_passçš„é…ç½®å†…å®¹ + åŸå§‹è¯·æ±‚ uri ä¸­å»é™¤æ‰åè®®ã€ä¸»æœºã€ç«¯å£å’Œlocationé…ç½®å†…å®¹åçš„å‰©ä½™éƒ¨åˆ†ã€‚ä¸Šè¿°ä¸¤ä¸ª url ä¸­ï¼Œ/ å’Œ /foo å°±æ˜¯è¿™é‡Œè¯´çš„ uri

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œproxy_passåœ¨åˆ›å»ºæ–°çš„è½¬å‘åœ°å€æ—¶ï¼Œæ€»æ˜¯ä¼šå‰”é™¤æ‰åŸå§‹uriä¸­çš„åè®®ã€ä¸»æœºã€ç«¯å£ã€‚æ ¸å¿ƒå·®å¼‚åœ¨äºæ˜¯å¦è¦å»é™¤æ‰locationæŒ‡ä»¤çš„é…ç½®å†…å®¹ã€‚å¦‚æœproxy_passé…ç½®å¸¦æœ‰uriå°±å»é™¤ï¼Œåä¹‹åˆ™ä¸å»é™¤ã€‚

å¦å¤–ï¼Œåƒhttp://localhost:8379/è¿™ä¸ªåœ°å€å¾ˆç‰¹åˆ«ï¼Œå› ä¸ºå»é™¤æ‰åè®®ã€ä¸»æœºã€ç«¯å£åï¼Œå°±åªå‰©ä¸‹ / äº†ï¼Œè¿™å¤§æ¦‚å°±æ˜¯â€œä»¥æ–œæ ç»“å°¾çš„ proxy_pass ä¼šå»é™¤æ‰ location çš„é…ç½®å†…å®¹â€è¿™ä¸ªé”™è¯¯è¯´æ³•çš„æºå¤´äº†ã€‚äº‹å®ä¸Šï¼Œåƒhttp://localhost:8379/fooè¿™ä¸ªåœ°å€ï¼Œuri ä¸º /fooï¼Œå®ƒå¹¶æ²¡æœ‰ä»¥ / ç»“å°¾ï¼Œä½†åœ¨ç”Ÿæˆæ–°çš„è½¬å‘ uri æ—¶ï¼ŒåŒæ ·ä¼šå»é™¤æ‰ location çš„é…ç½®å†…å®¹ã€‚

## å®ä¾‹æ¼”ç¤º

ä¸Šé¢åªæ˜¯å¯¹locationå’Œproxy_passä¸¤ä¸ªæŒ‡ä»¤çš„æ–œæ ç»“å°¾ä¹‹äº‰è¿™ä¸ªè¯¯ä¼šï¼Œä»ç†è®ºä¸Šåšå‡ºäº†è§£é‡Šã€‚ä½†è¿˜ä¸å½¢è±¡ï¼Œä¸æ˜“ç†è§£ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªå®ä¾‹ï¼Œä»¥åŠ æ·±ç†è§£ã€‚
ã€€ã€€
**locationä¸­æ— proxy_passçš„æƒ…å†µ**

ç¤ºä¾‹é…ç½®å¦‚ä¸‹

```nginx
location /books/ {               # é…ç½®Aï¼šä»¥ / ç»“å°¾
    root /var/www/mall/;
    ...
}
 
location /shop/goods {           # é…ç½®Bï¼šæ—  / ç»“å°¾
    root /var/www/mall/sell;
    ...
}
 
location /store {
    root /var/www/mall/store;    # é…ç½®Cï¼šæ ¹ç›®å½•çš„æœ€åä¸€çº§ï¼Œåç§°ä¸locationçš„å‰ç¼€é…ç½®å†…å®¹ä¸€è‡´
    ...
}
```

ä¸‹é¢æ˜¯å‡ ä¸ªä¸åŒçš„uriï¼Œæ‰€åŒ¹é…çš„locationï¼Œä»¥åŠå®ƒä»¬å¯¹åº”çš„èµ„æºæ–‡ä»¶åœ¨æœåŠ¡å™¨ç£ç›˜ä¸Šçš„è·¯å¾„ä½ç½®ã€‚

| è¯·æ±‚                                          | åŒ¹é…çš„location | æ–‡ä»¶ä½ç½®                                           |
|---------------------------------------------|-------------|------------------------------------------------|
| http://localhost/books/red-rock.html        | é…ç½®A         | /var/www/mall/books/red-rock.html              |
| http://localhost/shop/goods/keep-alive.html | é…ç½®B         | /var/www/mall/sell/shop/goods/keep-alive.html  |
| http://localhost/store/yalu-river.html      | é…ç½®C         | /var/www/mall/store/store/yalu-river.html      |
| http://localhost/store-central.html         | é…ç½®C         | /var/www/mall/store/store-central.html         |

ç®€è€Œè¨€ä¹‹ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œèµ„æºæ–‡ä»¶åœ¨ç£ç›˜çš„è·¯å¾„ä¸ºï¼šlocationé…ç½®çš„æ ¹ç›®å½• + uriã€‚å¯è§ï¼Œlocationé…ç½®ç»“å°¾çš„ / å­—ç¬¦ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«ä¹‹å¤„ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ã€‚

**locationä¸­æœ‰proxy_passçš„æƒ…å†µ**

ç¤ºä¾‹é…ç½®å¦‚ä¸‹

```nginx
location /films/ {
    proxy_pass http://film-server/;               # é…ç½®Aï¼šå¸¦äº†ä¸€ä¸ªæœ€ç®€çŸ­uri
}
location /comments/ {
    proxy_pass http://comment-server;             # é…ç½®Bï¼šä¸å¸¦uri
}
location /comments/top/ {
    proxy_pass http://comment-server/top/;        # é…ç½®Cï¼šæŒ‡å®šäº†uriï¼Œä¸”ä»¥ / ç»“å°¾
}
location /feedbacks/ {
    proxy_pass http://feekback-server/center      # é…ç½®Dï¼šæ˜¯ä¸€ä¸ªç¨å¾®é•¿ä¸€ç‚¹çš„uriï¼Œä½†æ²¡æœ‰ä»¥ / ç»“å°¾
}
```

ä¸‹é¢æ˜¯ä¸€ç»„WEBè¯·æ±‚çš„è½¬å‘æƒ…å†µ

| è¯·æ±‚                                       | åŒ¹é…çš„location | ç”Ÿæˆçš„ä»£ç†åœ°å€                               | è¯´æ˜                                                                           |
|------------------------------------------|-------------|---------------------------------------|------------------------------------------------------------------------------|
| http://localhost/films/wandering-earth   | é…ç½®A         | http://film-server/wandering-earth    | ç”±äºproxy_passçš„é…ç½®æŒ‡å®šäº†uriï¼Œæ–°çš„ä»£ç†åœ°å€å°†ä¸åŒ…å«locationçš„é…ç½®ï¼ˆå³/films/ï¼‰                        |
| http//localhost/comments/list            | é…ç½®B         | http://comment-server/comments/list   | ç”±äºproxy_passçš„é…ç½®ä¸å¸¦uriï¼Œæ–°çš„ä»£ç†åœ°å€ä¼šä¿ç•™locationçš„é…ç½®ï¼ˆå³/comments/ï¼‰                       |
| http://localhost/comments/top/asc100     | é…ç½®C         | http://comment-server/top/asc100      | æ–°çš„ä»£ç†åœ°å€å°†ä¸åŒ…å«locationçš„é…ç½®, å…¶ä¸­çš„topæ¥è‡ªproxy_passçš„é…ç½®ï¼Œè€Œélocation                      |
| http://localhost/comments/top/..//desc50 | é…ç½®B         | http://comment-server/comments/desc50 | è¯·æ±‚çš„uriç»è¿‡è§„èŒƒåŒ–å¤„ç†åå˜æˆäº†http://localhost/comments/desc50ï¼Œç„¶åæ‰å¼€å§‹åŒ¹é…ï¼Œå› æ­¤åŒ¹é…çš„locationä¸ºé…ç½®B  |
| http://localhost/feedbacks/list          | é…ç½®D         | http://comment-server/centerlist      | æ–°çš„ä»£ç†åœ°å€å°†ä¸åŒ…å«locationçš„é…ç½®, ç”±äºproxy_passçš„é…ç½®æœ«å°¾æ²¡æœ‰æ–œæ ï¼Œæ‰€ä»¥ç›´æ¥æ‹¼æ¥åï¼Œä¼šå¾—åˆ°centerlistè¿™ä¸ªä¸²        |

# locationæŒ‡ä»¤é…ç½®è¯¦è§£

locationæŒ‡ä»¤æ˜¯ngx_http_core_moduleä¸­çš„ä¸€ä¸ªæœ€å¸¸ç”¨çš„æŒ‡ä»¤ï¼Œå®ƒå°†ä¸åŒçš„è¯·æ±‚uriæ˜ å°„åˆ°ä¸åŒçš„Webèµ„æºé…ç½®ã€‚

ğŸ ç‰¹åˆ«è¯´æ˜ï¼šlocationæŒ‡ä»¤åŒ¹é…çš„æ˜¯è¯·æ±‚uriï¼Œè€Œä¸æ˜¯æ•´ä¸ªè¯·urlï¼Œè¿™é‡Œçš„uriæ˜¯urlä¸­ç«¯å£ä¸é—®å·(ï¼Ÿ)ä¹‹é—´çš„éƒ¨åˆ†ã€‚æ¯”å¦‚ http://localhost:1983/books/list?author=janeè¿™ä¸ªURLï¼Œå‚ä¸åŒ¹é…çš„uriä¸º/books/list

- æŒ‡ä»¤æ ¼å¼
    æœ‰ä¸¤ç§è¯­æ³•æ ¼å¼ï¼Œå¦‚ä¸‹ï¼š

    - location [ = | ~ | ~* | ^~ ] uri { ... }
    - location @name { ... }

- é€‚ç”¨èŒƒå›´
    
    åœ¨serveræŒ‡ä»¤å†…ï¼Œæˆ–locationæŒ‡ä»¤å†…ï¼ˆå³locationæŒ‡ä»¤æ˜¯å¯ä»¥è‡ªåµŒå¥—çš„ï¼‰

- åŠŸèƒ½ç”¨é€”
    
    æ ¹æ®åŒ¹é…çš„uriæŸ¥æ‰¾æœåŠ¡å™¨ä¸Šçš„ç£ç›˜æ–‡ä»¶ï¼Œå†ä»¥åˆé€‚çš„webå½¢å¼è¿”å›ï¼Œæˆ–ä»£ç†ï¼ˆè½¬å‘ï¼‰åˆ°å…¶å®ƒwebæœåŠ¡ï¼ˆè¿™éœ€è¦ä»£ç†ç±»æŒ‡ä»¤é…åˆï¼Œå¦‚proxy_passï¼‰

locationæŒ‡ä»¤åœ¨åŠŸèƒ½å±‚é¢ä¸Šçš„æµç¨‹å¦‚ä¸‹ â‘£ï¼š

```text
                  locationå†…æ˜¯å¦æœ‰ä»£ç†ç±»æŒ‡ä»¤
               +--------------------------------+ 
WebRequest --> | Does contains proxy instruct ? |---- No ---> è¿”å›æœåŠ¡å™¨ç£ç›˜ä¸Šçš„æ–‡ä»¶  â˜…
               +--------------------------------+
                               |
                              Yes
                               |
                               +---------> ä»£ç†åˆ°å…¶å®ƒWEBæœåŠ¡
```

æœ¬å°èŠ‚åªä»‹ç»locationå†…æ²¡æœ‰ä»£ç†ç±»æŒ‡ä»¤çš„æƒ…å†µï¼Œå³ä¸Šé¢æµç¨‹ä¸­æ ‡â˜…å¤„ã€‚æœ‰ä»£ç†çš„æƒ…å†µï¼Œå°†åœ¨prxoy_passæŒ‡ä»¤ä¸­è¯¦ç»†é˜è¿°ã€‚

## æ¨¡æ¿location

æ¨¡æ¿å‹locationï¼Œå³ location [ = | ~ | ~* | ^~ ] uri { ... } è¿™ç§è¯­æ³•ï¼Œå®ƒå…±æœ‰å››éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š

- locationå…³é”®å­—ï¼šè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯locationæŒ‡ä»¤çš„æ ‡è¯†

- uriåŒ¹é…æ¨¡å¼ï¼šä¹Ÿå«åŒ¹é…ä¿®é¥°ç¬¦ï¼Œå®ƒè¡¨æ˜ä»¥ä»€ä¹ˆæ–¹å¼æ¥åŒ¹é…è¯·æ±‚çš„uriï¼Œå…±5ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šç©ºã€= ã€~ ã€~* ã€^~

- uriåŒ¹é…æ ·å¼ï¼šä¹Ÿå«uriæ¨¡æ¿ï¼Œå®ƒæ˜¯å„ä¸ªå…·ä½“çš„åŒ¹é…æ¨¡å¼è¦ä½¿ç”¨çš„uriæ ·å¼å†…å®¹

locationçš„åŒ¹é…æ¨¡å¼åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼šå‰ç¼€åŒ¹é…ã€ç²¾ç¡®åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼š

- æ— æˆ–ç©º

    å³ä¸æŒ‡å®šä»»ä½•åŒ¹é…æ¨¡å¼ç¬¦å·ï¼Œæ­¤æ—¶ï¼Œå®ƒä»£è¡¨å‰ç¼€åŒ¹é…ã€‚æ¯”å¦‚ location /books/ { ... }ï¼Œå®ƒå¯ä»¥åŒ¹é…/books/index.htmlã€/books/computer/GitDefinitiveGuide.pdf

- =

    ç¬¦å· = ä»£è¡¨ç²¾ç¡®åŒ¹é…ï¼Œè¦æ±‚è¯·æ±‚çš„uriä¸è¯¥ç¬¦å·åçš„uriæ ·å¼å®Œå…¨ä¸€æ ·ï¼Œæ¯”å¦‚ location = /books { ... }ï¼Œå®ƒå¯ä»¥ç²¾ç¡®çš„åŒ¹é…/booksè¿™æ ·çš„uriï¼Œåƒ/books/ã€/books/index.htmlã€/books.docã€/booksmark.pdfè¿™æ ·çš„uriå‡æ— æ³•åŒ¹é…ã€‚

    ç²¾ç¡®åŒ¹é…ä¸€æ—¦æˆåŠŸï¼Œåˆ™æ•´ä¸ªåŒ¹é…è¿‡ç¨‹ç»“æŸï¼Œä¸å†ç»§ç»­å°è¯•åŒ¹é…å…¶å®ƒçš„location

- ~

    ç¬¦å· ~ ä»£è¡¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå¹¶ä¸”æ˜¯åŒºåˆ†å¤§å°çš„ã€‚æ¯”å¦‚ location ~ \.(gif|jpg|PNG)$ { ... }ï¼Œå®ƒå¯ä»¥åŒ¹é…/red-rock.jpgå’Œ/img/pigion.gifï¼Œä½†ä¸èƒ½åŒ¹é…/img/greatwall.pngï¼Œå› ä¸ºè¿™é‡Œçš„pngæ˜¯å°å†™çš„ï¼Œè€Œ ~ åŒ¹é…çš„å­—ç¬¦æ˜¯å¤§å°å†™æ•æ„Ÿçš„ã€‚

- ~*

    ç¬¦å· ~* ä»£è¡¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå¹¶ä¸”å®ƒä¸åŒºåˆ†å¤§å°çš„ã€‚æ¯”å¦‚ location ~* \.(gif|jpg|PNG)$ { ... }ï¼Œå®ƒå¯ä»¥åŒ¹é…/red-rock.jpgå’Œ/img/pigion.gifï¼Œæˆ–å¯ä»¥/img/greatwall.pngï¼Œå°½ç®¡è¿™é‡Œçš„pngæ˜¯å°å†™çš„ï¼Œä½† ~* åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™ï¼Œä¾ç„¶å¯ä»¥åŒ¹é…ã€‚

- ^~

    ç¬¦å· ^~ ä»£è¡¨çš„åŒ¹é…è§„åˆ™å¾ˆç‰¹åˆ«ï¼Œå®ƒçœ‹ä¸Šå»åƒæ˜¯ä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼Œå®åˆ™ä¸æ˜¯ï¼Œå®ƒä¾ç„¶ä»£è¡¨çš„æ˜¯å‰ç¼€åŒ¹é…ï¼Œä¸é»˜è®¤çš„å‰ç¼€åŒ¹é…ï¼ˆå³æ²¡æœ‰ä»»ä½•ç¬¦å·çš„é‚£ç§ï¼‰çš„åŒºåˆ«æ˜¯ï¼šå‡å®šä¸€ä¸ªserverå†…é…ç½®äº†å¤šä¸ªå‰ç¼€å‹çš„locationå’Œå¤šä¸ªæ­£åˆ™locationï¼Œå¦‚æœè¿™äº›å‰ç¼€locationä¸­ï¼Œæœ€ç»ˆåŒ¹é…çš„locationæ˜¯ä¸€ä¸ª ^~ çš„è¯ï¼Œåˆ™ä¸å†å°è¯•åç»­çš„æ­£åˆ™åŒ¹é…ã€‚

    ç®€è€Œè¨€ä¹‹ï¼Œ^~å°±æ˜¯ä¸€ä¸ªç¦æ­¢åšæ­£åˆ™åŒ¹é…çš„å‰ç¼€åŒ¹é…ï¼Œä»å®ƒçš„åŠŸèƒ½å®šä¹‰ä¸Šæ¥çœ‹ï¼Œè¿™ä¸ª^~ç¬¦å·æ”¹æˆ!~æ›´å½¢è±¡äº›ï¼Œæ¯•ç«Ÿæ„Ÿå¹å·!å°±ä»£è¡¨å¦å®šçš„æ„æ€ï¼Œè€Œ^æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šç¬¦å·ï¼Œå¾ˆå®¹æ˜“å¼•èµ·è¯¯ä¼šã€‚

locationæŒ‡ä»¤çš„å¤„ç†æµç¨‹ï¼Œæ€»ä½“ä¸Šåˆ†ç±»ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ï¼šuriè§„èŒƒåŒ–å¤„ç†ã€uriåŒ¹é…ã€åç½®å¤„ç†ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼š

1. uriè§„èŒƒåŒ–å¤„ç†
    è¿™ä¸€æ­¥æ˜¯å¤„ç†åŸå§‹uriä¸²ä¸­ä¸è§„èŒƒçš„å†…å®¹ï¼Œå°†å…¶è§„èŒƒèŠ±åï¼Œæ–¹ä¾¿åç»­åšåŒ¹é…ï¼Œè¿™äº›å¤„ç†åŒ…æ‹¬ï¼š

    - è§£ç  &xx è¿™æ ·çš„urlç¼–ç å­—ç¬¦
    - è§£æ . å’Œ .. åˆ°è¿™äº›ç¬¦å·æ‰€å¼•ç”¨çš„ç›®å½•ä¸Šï¼Œæ¯”å¦‚/comment/top/../top100ï¼Œå¤„ç†åä¼šå˜æˆ/comment/top100
    - å°†å¤šä¸ªè¿ç»­çš„/å‹ç¼©æˆä¸€ä¸ªï¼Œæ¯”å¦‚/films/science-fiction///wandering-earthï¼Œå¤„ç†åä¼šå˜æˆ/films/science-fiction/wandering-earth

2. uriåŒ¹é…

    uriåŒ¹é…æœ‰å‰é¢æåˆ°çš„ä¸‰ç§ç±»å‹ï¼Œå³ï¼šç²¾ç¡®åŒ¹é…ã€å‰ç¼€åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ã€‚å‡å®šä¸€ä¸ªserveré…ç½®ä¸­ï¼Œæœ‰å¤šä¸ªç²¾ç¡®åŒ¹é…çš„   locationã€å¤šä¸ªå‰ç¼€åŒ¹é…çš„locationå’Œå¤šä¸ªæ­£åˆ™åŒ¹é…çš„locationã€‚åˆ™æ•´ä¸ªåŒ¹é…æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

    - å…ˆåšç²¾ç¡®åŒ¹é…ï¼ŒæŒ‰ç…§ç²¾ç¡®åŒ¹é…locationåœ¨é…ç½®æ–‡ä»¶ä¸­çš„å‡ºç°é¡ºåºè¿›è¡Œï¼Œä¸€æ—¦å‘½ä¸­ä¸€ä¸ªï¼Œåˆ™æ•´ä¸ªåŒ¹é…è¿‡ç¨‹ç»“æŸã€‚

    - è‹¥ç²¾ç¡®åŒ¹é…æ²¡æœ‰å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‰ç¼€åŒ¹é…ï¼ŒæŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­å‰ç¼€locationå‡ºç°çš„é¡ºåºæ‰§è¡Œï¼Œå¦‚æœå‘½ä¸­å¤šä¸ªï¼Œåˆ™åªè®°å½•  locationé…ç½®å†…å®¹æœ€é•¿çš„é‚£ä¸ªã€‚
    å‡å®šæœ‰ä¸¤ä¸ªå‰ç¼€é…ç½®åˆ†åˆ«æ˜¯ï¼šlocation /films/ { ... } å’Œ location /films/nature/ { ... }ã€‚è¯·æ±‚åœ°å€/    films/nature/aerial-view-of-china.mp4ä¸è¿™ä¸¤ä¸ªå‰ç¼€locatoné…ç½®å‡èƒ½åŒ¹é…ï¼Œä½†æœ€ç»ˆå°†åªä¿ç•™ç¬¬äºŒä¸ªåŒ¹é…ï¼Œå›   ä¸ºå®ƒçš„é…ç½®å‰ç¼€ï¼ˆå³/films/natureï¼‰æœ€é•¿ã€‚ç”±æ­¤å¯ä»¥æ¨æ–­å‡ºï¼Œé»˜è®¤çš„é…ç½®ï¼ˆå³ location / { ... } ï¼‰ä¸€å®šæ˜¯å…œ   åº•çš„åŒ¹é…ï¼Œå½“æ‰€æœ‰å…¶å®ƒç±»å‹çš„åŒ¹é…å‡æœªå‘½ä¸­æ—¶ï¼Œå®ƒä¸€å®šèƒ½å‘½ä¸­ã€‚

    - æ¥ç€å†æŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­çš„é¡ºåºï¼Œæ‰§è¡Œæ­£åˆ™åŒ¹é…ï¼Œä¸å‰ç¼€åŒ¹é…ä¸åŒçš„æ˜¯ï¼šä¸€æ—¦å‘½ä¸­ä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼Œæ•´ä¸ªåŒ¹é…å°±ç»“æŸ    äº†ï¼Œä¸å†å¯¹åé¢çš„æ­£åˆ™locationè¿›è¡ŒåŒ¹é…ã€‚å¹¶ä¸”æ•´ä¸ªåŒ¹é…çš„ç»“æœå°±æ˜¯è¿™ä¸ªæ­£åˆ™locationã€‚å¦‚æœæ²¡æœ‰ä¸€ä¸ªæ­£åˆ™å‘½ä¸­ï¼Œ    åˆ™æ•´ä¸ªåŒ¹é…çš„ç»“æœå°±æ˜¯ä¸Šé¢å‰ç¼€åŒ¹é…ä¸­ï¼Œè®°å½•çš„é‚£ä¸ªlocationå†…å®¹æœ€é•¿çš„å‘½ä¸­ç»“æœã€‚
    å‡å®šæœ‰ä¸¤ä¸ªæ­£åˆ™é…ç½®åˆ†åˆ«æ˜¯ï¼šlocation ~* \.(jpg|gif|png)$ { ... } å’Œ location ~* \.(png|jpeg|svg)$     { ... }ã€‚è¯·æ±‚åœ°å€/img/logo.pngå°†åªä¼šä¸ç¬¬ä¸€ä¸ªåŒ¹é…ï¼Œå°½ç®¡å®ƒä¹Ÿæ»¡è¶³ç¬¬äºŒä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†ç”±äºç¬¬ä¸€ä¸ªæ­£åˆ™çš„ä½    ç½®åœ¨å‰ï¼Œå¹¶ä¸”åŒ¹é…æˆåŠŸï¼Œå› æ­¤å°±ä¸å†è¿›è¡Œåé¢çš„åŒ¹é…äº†ã€‚

    > ğŸ ä¾‹å¤–æƒ…å†µï¼šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å‰ç¼€åŒ¹é…ï¼Œå³ï¼š^~ï¼Œå¦‚æœåœ¨å‰ç¼€åŒ¹é…ç»“æŸåï¼Œå‘½ä¸­çš„locationæ˜¯ç”¨ ^~ ä¿®é¥°çš„ï¼Œå°±ä¸ä¼šè¿›å…¥æ­£åˆ™åŒ¹é…é˜¶æ®µäº†ã€‚

3. åç½®å¤„ç†

åœ¨uriåŒ¹é…ç»“æŸåï¼Œä¾¿æ‰§è¡Œå‘½ä¸­locationæŒ‡ä»¤ä¸­ï¼ŒèŠ±æ‹¬å·{}å†…çš„æŒ‡ä»¤ã€‚ä¸»è¦æœ‰ä¸¤ç±»ï¼Œè¦ä¹ˆæ˜¯ä»rootæŒ‡ä»¤é…ç½®çš„ç›®å½•ä¸‹æŸ¥æ‰¾ç›¸åº”çš„æ–‡ä»¶ï¼Œè¦ä¹ˆæ‰§è¡Œå…¶å®ƒä»£ç†ç±»ï¼ˆè§ç¬¬â‘ å¤„ï¼‰æŒ‡ä»¤ï¼Œæ•´ä¸ªæµç¨‹ä¸â‘£å¤„æè¿°ä¸€è‡´ã€‚

ä¸‹å›¾å±•ç¤ºäº†æ•´ä¸ªlocationæŒ‡ä»¤çš„æ‰§è¡Œæµç¨‹
locationæŒ‡ä»¤æ‰§è¡Œæµç¨‹

ä¸‹è¡¨å¯¹å„ä¸ªåŒ¹é…ä¿®é¥°ç¬¦è¿›è¡Œäº†æ•´ç†å¯¹æ¯”ï¼Œå…¶ä¸­çš„ä¼˜å…ˆçº§æ•°å­—1ã€2ã€3ï¼Œæ˜¯æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜

| ä¿®é¥°ç¬¦ | ä¼˜å…ˆçº§ | æ˜¯å¦ä¸ºæ­£åˆ™ | åŒºåˆ†å¤§å°å†™ | å‘½ä¸­åç»§ç»­åŒ¹é…                     | å¤‡æ³¨                                              |
|-----|-----|-------|-------|-----------------------------|-------------------------------------------------|
| 2   | âŒ   | âœ”ï¸    | âœ”ï¸    | ç¬¬ä¸€åˆ—æ²¡æœ‰å†…å®¹ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•å­—ç¬¦ï¼Œå…¶å«ä¹‰å°±æ˜¯å‰ç¼€åŒ¹é…  |                                                 |
| =   | 1   | âŒ     | âœ”ï¸    | âŒ                           |                                                 |
| ^~  | 2   | âŒ     | âœ”ï¸    | âœ”ï¸                          | åœ¨æ•´ä¸ªå‰ç¼€åŒ¹é…ç»“æŸåï¼Œå¦‚æœæœ€ç»ˆç»“æœæ˜¯ä¸€ä¸ª^~ä¿®é¥°çš„location, åˆ™ä¸è¿›è¡Œåç»­çš„æ­£åˆ™åŒ¹é…  |
| ~   | 3   | âœ”ï¸    | âŒ     | âŒ                           |                                                 |
| ~*  | 3   | âœ”ï¸    | âœ”ï¸    | âŒ                           |                                                 |

ä¸€ä¸ªå°ä¼˜åŒ–
é€šå¸¸æƒ…å†µä¸‹ï¼Œserveré‡Œéƒ½ä¼šæœ‰ä¸€ä¸ªlocation / {...} è¿™æ ·çš„é…ç½®ï¼Œå®ƒå¯ä»¥åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚ã€‚å¦‚æœä¸€ä¸ªç½‘ç«™çš„é¦–é¡µè®¿é—®æœ€é¢‘ç¹ï¼Œæ¯”å¦‚ http://localhsot/ï¼Œä½†è¯¥ç½‘ç«™å´é…ç½®äº†éå¸¸å¤šçš„ locationï¼Œé‚£ä¹ˆé¦–é¡µuriè¿™ä¸ªè¯·æ±‚ï¼Œéœ€è¦åœ¨åŒ¹é…å®Œæ‰€æœ‰çš„locationåï¼Œæ‰èƒ½å¾—å‡ºæœ€ç»ˆå‘½ä¸­çš„ locationä¸º / ã€‚åœ¨æ­¤æœŸé—´ï¼Œå…¶å®ƒçš„é‚£äº›åŒ¹é…å°è¯•æ˜æ˜¾æ˜¯å¤šä½™çš„ã€‚ä¸ºæ­¤ï¼Œå¯èƒ½é€šè¿‡ä¸º / æä¾›ä¸€ä¸ªç²¾ç¡®åŒ¹é…æ¥æé«˜æ€§èƒ½ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š

```nginx
location = / {
    ...
}
location / {
    ...
}
```

å¦å¤–ï¼Œåƒlocation = / {...} è¿™ç§ç²¾ç¡®åŒ¹é…ï¼Œå†…éƒ¨å†åµŒå¥—locationæŒ‡ä»¤å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚

### å‡ ä¸ªç‰¹ä¾‹

å‰ç¼€åŒ¹é…æ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼Œæ¯”å¦‚ location /books/ {...} è¿™ä¸ªæŒ‡ä»¤ï¼Œè¯·æ±‚/boOKs/red-rock.htmlå°±ä¸åŒ¹é…ã€‚ä½†åœ¨ä¸€äº›å¤§å°å†™ä¸æ•æ„Ÿçš„æ“ä½œç³»ç»Ÿä¸Šï¼ˆå¦‚MacOSå’ŒCygwinï¼‰ï¼Œ0.7.7ç‰ˆæœ¬ä»¥åçš„nginxï¼Œåˆ™æ˜¯èƒ½å¤ŸåŒ¹é…çš„ã€‚å¦‚æœä½ æ‰“ç®—éªŒè¯ä¸€ä¸‹è¿™ä¸ªå¤§å°å†™æ•æ„Ÿçš„é—®é¢˜ï¼Œå»ºè®®ä¸è¦é€šè¿‡æµè§ˆå™¨æ–¹å¼ï¼Œå› ä¸ºæµè§ˆå™¨ä¼šå°†uriåœ°å€åšè§„èŒƒåŒ–å¤„ç†ã€‚å»ºè®®é€šè¿‡å‘½ä»¤è¡Œå·¥å…·æ¥éªŒè¯ï¼Œæ¯”å¦‚linuxä¸‹çš„curlå’Œwgetã€‚

0.7.40ç‰ˆæœ¬ä»¥åçš„nginxï¼Œå…¶æ­£åˆ™åŒ¹é…ä¸­çš„æ•è·ç»„æ˜¯å¯ä»¥åœ¨å…¶åçš„å…¶å®ƒæŒ‡ä»¤ä¸­å¼•ç”¨çš„ã€‚

0.7.1 ~ 0.8.41è¿™ä¸ªç‰ˆæœ¬èŒƒå›´å†…çš„nginxï¼Œæœ‰ç‚¹ç‰¹æ®Šï¼Œåªè¦å‘½ä¸­ä¸€ä¸ªå‰ç¼€åŒ¹é…å°±ç«‹å³ç»“æŸï¼Œä¸å†åŒ¹é…åç»­çš„å‰ç¼€locationï¼Œä¹Ÿä¸åŒ¹é…å…¶å®ƒæ­£åˆ™locationã€‚å› æ­¤ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯è¿™ä¸ªèŒƒå›´å†…çš„nginxï¼Œåœ¨é…ç½®locationæ—¶ï¼Œå°±å¾—ç²¾å¿ƒæŒ‰æ’å¥½å„ä¸ªlocationåœ¨é…ç½®æ–‡ä»¶ä¸­çš„é¡ºåºï¼Œé¿å…ä¸€ä¸ªç›¸ä¼¼çš„ï¼Œå†…å®¹è¾ƒçŸ­çš„locationé…ç½®å‡ºç°åœ¨è¾ƒé•¿è€…çš„å‰é¢ã€‚

### æ–‡ä»¶è·¯å¾„æ’é™¤URIä¸­çš„åŒ¹é…é¡¹

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›èµ„æºæ–‡ä»¶çš„è·¯å¾„ä¸­ï¼Œä¸è¦å‡ºç°URIä¸­å·²åŒ¹é…çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªåœºæ™¯ï¼š

```nginx
location /book/ {
    root /var/www/book;
}
```

è¯·æ±‚åœ°å€ http://localhost/book/ruby-on-rails-guide.pdfï¼Œå¯¹åº”åˆ°ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ä¸º /var/www/book/book/ruby-on-rails-guide.pdfã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªè¿ç»­çš„bookç›®å½•ï¼Œç¬¬ä¸€bookæ¥è‡ªrootæŒ‡ä»¤é…ç½®çš„æ ¹ç›®å½•è·¯å¾„ï¼Œç¬¬äºŒä¸ªbookæ¥è‡ªè¯·æ±‚uriã€‚ä½†æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè·¯å¾„ä¸Šåªæœ‰ä¸€ä¸ªbookç›®å½•ï¼Œæˆ–è€…è¯´æ–‡ä»¶è·¯å¾„ä¸­ï¼Œä¸è¦åŒ…å«uriä¸­åŒ¹é…çš„locationéƒ¨åˆ†ï¼Œå°±åƒè¿™æ ·: /var/www/book/nginx-definitive-guide.pdfã€‚ç”¨aliasæŒ‡ä»¤æ›¿æ¢rootå¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå³åƒä¸‹é¢é…ç½®:

```nginx
location /book/ {
    alias /var/www/book/;     # å°†åŸæ¥çš„rootæ›¿æ¢æˆalias
}
```

aliasæŒ‡ä»¤è¡¨æ˜ï¼Œåœ¨ç”Ÿæˆæ–‡ä»¶è·¯å¾„æ—¶ï¼Œç”¨aliasæŒ‡ä»¤åé¢çš„å­—ç¬¦ä¸²ï¼Œæ›¿æ¢æ‰è¯·æ±‚uriä¸­ä¸locationåŒ¹é…çš„éƒ¨åˆ†ï¼Œå› æ­¤ï¼Œè¯¥æŒ‡ä»¤åé¢çš„å†…å®¹ï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯uriä¸­åŒ¹é…éƒ¨åˆ†çš„åˆ«åã€‚

å¦‚æœlocationé…ç½®ä¸ºæ­£åˆ™åŒ¹é…ï¼Œæ ¹æ®aliasçš„åŠŸèƒ½å®šä¹‰ï¼Œå®ƒä¼šæ›¿æ¢æ‰æ•´ä¸ªè¯·æ±‚çš„uriï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰åŒ¹é…æ­¤æ­£åˆ™locationçš„è¯·æ±‚ï¼Œéƒ½å°†è¿”å›ç›¸åŒçš„å†…å®¹ï¼Œå³aliasæŒ‡ä»¤æ‰€é…ç½®çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚æ­¤æ—¶ï¼Œ

- å¦‚æœaliasåé¢çš„æ–‡æœ¬æŒ‡å‘ä¸€ä¸ªå·²å­˜åœ¨çš„ç›®å½•ï¼Œåˆ™ä¼šå¼•å‘é‡å®šå‘

- å¦‚æœaliasåé¢çš„æ–‡æœ¬æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œåˆ™ä¼šè¿”å›404

ä¸Šè¿°è¡Œä¸ºæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼Œå®ƒåº”è¯¥æ ¹æ®uriçš„ä¸åŒï¼Œè¿”å›ä¸åŒå†…å®¹ï¼ˆwebèµ„æºæ–‡ä»¶ï¼‰ã€‚è¦è¾¾åˆ°æ­¤ç›®çš„ï¼Œéœ€è¦åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­æ·»åŠ æ•è·ç»„ï¼Œå¹¶åœ¨aliasæŒ‡ä»¤ä¸­å¼•ç”¨å®ƒä»¬ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```nginx
location ~* ^/avatar/(.+\.(?:jpg|jpeg|gif|png))$ {
    alias /var/www/user/avatar/$1;
}
```

å½“è®¿é—® http://localhost/avatar/jane.pngæ—¶ï¼Œå°†è¿”å› /var/wwww/user/avatar/jane.pngæ–‡ä»¶ã€‚

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒaliasæŒ‡ä»¤ä»…ä»…æ˜¯ç®€å•çš„å¼•ç”¨äº†å˜é‡$1ï¼Œå¹¶å°†å…¶è¿½åŠ åœ¨æœ«å°¾ï¼Œå®ƒå®Œå…¨å¯ä»¥ç”¨root /var/www/useræŒ‡ä»¤æ›¿ä»£ã€‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹æ›´ç¬¦åˆæ­£åˆ™locationä¸aliasçš„ç»„åˆï¼š

```nginx
location ~ "^/novel/(\d{4})/(\d{2})/\d{2})/(.+)-(.+)$" {
     alias /var/wwww/novel/$4/$1-$2-$3/$5.txt;
}
```

è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå°è¯´æ–‡ä»¶çš„é…ç½®ï¼Œ$1ã€$2ã€$3ã€$4ã€$5åˆ†åˆ«ä»£è¡¨å¹´ã€æœˆã€æ—¥ã€ä½œè€…ã€ä½œå“åï¼Œè¯·æ±‚http://localhost/novel/2023/03/15/YuHua-KeepAliveï¼Œå¯¹åº”çš„å“åº”æ–‡ä»¶è·¯å¾„ä¸ºï¼š/var/www/novel/YuHua/2023-03-15/KeepAlive.txt

> ç¤ºä¾‹äºŒä¸­çš„æ•´ä¸ªæ­£åˆ™è¡¨è¾¾å¼å†™åœ¨äº†ä¸€å¯¹å¼•å·å†…ï¼Œè¿™æ˜¯å› ä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¸­å«æœ‰èŠ±æ‹¬å· { å’Œ }ï¼Œå®ƒä»¬éƒ½æ˜¯nginxé…ç½®çš„å…³é”®å­—ï¼Œéœ€è¦åšç‰¹æ®Šå¤„ç†ã€‚ç»éªŒè¯ï¼Œå°†æ­£åˆ™è¡¨è¾¾å¼å†™åœ¨ä¸€å¯¹å¼•å·å†…å¯è§£å†³æ­¤é—®é¢˜ï¼Œè€Œé‡‡ç”¨å¯¹èŠ±æ‹¬å·å­—ç¬¦ä½¿ç”¨åæ–œæ ï¼ˆå³\{ å’Œ \}ï¼‰è½¬ä¹‰è¿™ç§æ–¹å¼ï¼Œæ˜¯ä¸è¡Œçš„ã€‚

### å‘½ålocation

é™¤äº†æ¨¡æ¿locationå¤–ï¼Œè¿˜æ”¯æŒä¸€ç§å«åšå‘½ålocationçš„è¯­æ³•ï¼Œå³ location @name {...} è¿™ç§ã€‚é¡¾åæ€ä¹‰ï¼Œå‘½ålocationå°±æ˜¯ä¸€ä¸ªå…·æœ‰åç§°çš„locationå®šä¹‰ï¼Œè¿™ä¸ªlocationä¸åŒ¹é…ä»»ä½•å¤–éƒ¨uriï¼Œå®ƒåªèƒ½åœ¨nginxå†…éƒ¨ä½¿ç”¨ï¼Œé€šå¸¸ä¸error_pageã€try_filesç­‰æŒ‡ä»¤ä¸€èµ·ä½¿ç”¨ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®(ç‚¹å‡»æŸ¥çœ‹):

```nginx
location /books/ {
    root /var/wwww/book-docs;
    index index.html;
    error_page 404 @fallback;   â˜†
}
 
location @fallback {
    proxy_pass http://baby-home-server;
}
```

æ ¹æ®ä¸Šé¢â˜†å¤„çš„é…ç½®ï¼Œå¦‚æœå‡ºç°äº†404é”™è¯¯ï¼Œä¼šå†…éƒ¨é‡å®šå‘åˆ°åç§°ä¸ºfallbackçš„locationä¸­ã€‚å°±æœ¬ç¤ºä¾‹è€Œè¨€ï¼Œå®ƒæœ€ç»ˆä¼šä»£ç†åˆ°baby-home-server(å®è´å›å®¶)è¿™ä¸ªWebæœåŠ¡ä¸Šï¼Œé€šå¸¸æ˜¯è¿”å›ä¸€ä¸ªäº²å­å¯»æ‰¾é¡µé¢ã€‚

# proxy_passæŒ‡ä»¤é…ç½®è¯¦è§£

proxy_passæŒ‡ä»¤ä¸»è¦ç”¨åœ¨locationæŒ‡ä»¤å†…ï¼Œå°†åŒ¹é…çš„è¯·æ±‚è½¬å‘åˆ°ä»£ç†çš„æœåŠ¡ä¸Šï¼Œè¿™å¯¹äºAPIç±»æœåŠ¡éå¸¸é€‚ç”¨ï¼Œå†é…åˆupstreamæŒ‡ä»¤çš„è¯ï¼Œè¿˜å¯å®ç°è´Ÿè½½å‡è¡¡ã€‚

- æŒ‡ä»¤è¯­æ³•ï¼šproxy_pass uri

- é€‚ç”¨èŒƒå›´ï¼šlocationæŒ‡ä»¤å†…ã€limit_expectæŒ‡ä»¤å†…ã€locationæŒ‡ä»¤å†…çš„ifè¯­å¥å—

æŒ‡ä»¤ä¸­çš„uriï¼Œåè®®éƒ¨åˆ†æ”¯æŒhttpå’Œhttpsã€‚ä¸»æœºéƒ¨åˆ†ï¼Œæ”¯æŒipåœ°å€ã€nginxè™šæ‹Ÿä¸»æœºç»„å’Œunix socketã€‚æ•´ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹ï¼š

- è½¬å‘åœ°å€åˆæˆ
    æ­£å¦‚å‰é¢â‘¢å¤„æ‰€è¿°ï¼Œproxy_passæŒ‡ä»¤æ–°è½¬å‘åœ°å€çš„åˆæˆé€»è¾‘ï¼Œä¸å®ƒåé¢é…ç½®çš„å†…å®¹æ˜¯å¦æ˜¯å¸¦æœ‰uriç›¸å…³ï¼Œå¦‚ä¸‹ï¼š

    - ä¸å¸¦uriæ—¶ï¼ˆå¦‚ http://localhost:8379ï¼‰è½¬å‘åœ°å€ä¸ºï¼šproxy_passçš„é…ç½®å†…å®¹ + åŸå§‹è¯·æ±‚uriä¸­å»é™¤æ‰åè®®ã€ä¸»æœºå’Œç«¯å£åçš„å‰©ä½™å†…å®¹
    - å¸¦æœ‰uriæ—¶ï¼ˆå¦‚ï¼šhttp://localhost:8379/ æˆ– http://localhost:8379/foo ï¼‰è½¬å‘åœ°å€ä¸ºï¼šproxy_passçš„é…ç½®å†…å®¹ + åŸå§‹è¯·æ±‚uriä¸­å»é™¤æ‰åè®®ã€ä¸»æœºã€ç«¯å£å’Œlocationé…ç½®å†…å®¹åçš„å‰©ä½™éƒ¨åˆ†
    
    > è¿™é‡Œçš„uriï¼Œæ˜¯æŒ‡è¯·æ±‚urlä¸­ï¼Œç«¯å£ä¸é—®å·ä¹‹é—´éƒ¨åˆ†ï¼Œå¦‚ http://localhost:1983/user/list?start=36&   minLevel=3ä¸­ï¼Œuriå†…å®¹ä¸º/user/list

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®

```nginx
location /student/ {
    proxy_pass http://edu-server;                  # é…ç½®â‘´
}
 
location /honour/ {                                # é…ç½®â‘µ
    proxy_pass http://edu-server/win-honours/;
}
 
location /score/ {                                 # é…ç½®â‘¶
    proxy_pass http://edu-server/final-score;
}
```

ä¸‹è¡¨åˆ—å‡ºäº†3ä¸ªä¸åŒé…ç½®çš„è½¬å‘uriåˆæˆæƒ…å†µ

| è¯·æ±‚                                            | å‘½ä¸­é…ç½® | è½¬å‘åœ°å€                                           | è¯´æ˜                                                                                    |
|-----------------------------------------------|------|------------------------------------------------|---------------------------------------------------------------------------------------|
| http://localhost/students/baseinfo/sophia.htm | é…ç½®â‘´  | http://edu-server/students/baseinfo/sophia.htm | è¯¥é…ç½®ä¸å¸¦uriï¼Œä»£ç†åœ°å€åªæ˜¯ç®€å•åœ°å°†proxy_passä¸locationé…ç½®æ‹¼æ¥                                            |
| http://localhost/honour/list                  | é…ç½®â‘µ  | http://edu-server/win-honours/list             | è¯¥é…ç½®æœ‰uriéƒ¨åˆ†ï¼Œæ•…ä»£ç†åœ°å€ä¸­ä¸ä¿ç•™locationä¸­åŒ¹é…çš„éƒ¨åˆ†ï¼ˆå³/honour/ï¼‰                                          |
| http://localhost/score/physical               | é…ç½®â‘¶  | http://edu-server/final-scorephysical          | ä¸ç¬¬äºŒä¸ªåŒç†ï¼Œåªæ˜¯æœ€ç»ˆçš„åœ°å€é‡Œï¼Œfinal-scorephysicalè¿™ä¸ªä¸²å¯èƒ½ä¸ç¬¦åˆå®é™…éœ€è¦ï¼Œè¿™é‡Œç‰¹æ„ä¸¾è¿™ä¸ªä¾‹å­ï¼Œæ˜¯ä¸ºäº†è¯´æ˜ï¼Œè½¬å‘uriçš„åˆæˆï¼Œä¸é…ç½®æœ«å°¾æ˜¯å¦æœ‰æ–œæ æ— å…³ |

- æ‰§è¡Œè½¬å‘
    åœ¨nginxå†…éƒ¨ï¼Œè°ƒç”¨è¿™ä¸ªæ–°çš„uriåœ°å€ï¼Œç„¶åå°†ç»“æœå›ä¼ ç»™æœ€åˆçš„å®¢æˆ·ç«¯ã€‚å¯¹äºä»£ç†åœ°å€ä¸­çš„hostéƒ¨åˆ†ï¼Œproxy_passæŒ‡ä»¤æ”¯æŒä»¥ä¸‹å››ç§ï¼š

    - ipåœ°å€
    æ¯”å¦‚http://192.168.56.101/courses/list, å°†ç›´æ¥è½¬è°ƒåˆ°ç›®æ ‡æœåŠ¡

    - è™šæ‹Ÿä¸»æœºç»„
    å°†æ ¹æ®è™šæ‹Ÿä¸»æœºç»„çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè½¬å‘åˆ°å…·ä½“çš„ç›®æ ‡æœåŠ¡ã€‚æ¯”å¦‚http://edu-server/courses/listï¼Œå…¶ä¸­edu-serveræ˜¯ä¸€ä¸ªè™šæ‹Ÿä¸»æœºç»„ï¼Œå°†æ ¹æ®edu-serverå†…çš„æœåŠ¡é…ç½®æƒ…å†µè¿›è¡Œè½¬å‘

    - åŸŸå
    å¦‚æœä¸€ä¸ªåŸŸåï¼Œé€šè¿‡åŸŸåè§£æå™¨åï¼Œå¾—åˆ°äº†ä¸€ç»„ipåœ°å€ï¼Œåˆ™å°†ä»¥å¾ªç¯çš„æ–¹å¼è°ƒç”¨è¿™äº›ipã€‚

    - UnixSocket
    nginxä¹Ÿæ”¯æŒunix socketæ–¹å¼çš„è½¬å‘ï¼Œä½†è¿™åœ¨ç”Ÿäº§å®è·µä¸­ï¼Œå¾ˆå°‘ä½¿ç”¨åˆ°ï¼Œå› ä¸ºå®ƒæ˜¯æœåŠ¡å™¨å†…çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œå°½ç®¡æ€§èƒ½æœ€å¥½ï¼Œä½†é™åˆ¶åœ¨äº†å•ä¸ªæœåŠ¡å™¨å†…ã€‚å¦å¤–ï¼Œè¿˜éœ€è¦å…¶å®ƒä¸€äº›é…ç½®ï¼Œæ‰èƒ½ä½¿unix socketçœŸæ­£å·¥ä½œèµ·æ¥

å½“hostä¸æ˜¯ä¸€ipæ—¶ï¼Œå®ƒæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªä¸»æœºç»„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªåŸŸåã€‚proxy_passæŒ‡ä»¤çš„å¤„ç†é¡ºåºä¸ºï¼šå…ˆå°è¯•æŸ¥æ‰¾ä¸»æœºç»„ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†å°è¯•åŸŸåè§£æã€‚

åœ¨åˆæˆè½¬å‘åœ°å€æ—¶ï¼Œæœ‰æ—¶å€™æ— æ³•ç¡®å®šè¯·æ±‚uriä¸­ï¼Œå“ªäº›éƒ¨åˆ†åº”è¯¥è¢«æ›¿æ¢æ‰ã€‚æ­¤æ—¶ï¼Œè¦ä¹ˆè½¬å‘çš„åœ°å€ä¸æŒ‡ä»¤ä¸å¸¦uriçš„æƒ…å†µç›¸åŒï¼Œè¦ä¹ˆé€šè¿‡å˜é‡æ¥æŒ‡å®šï¼Œä¸‹é¢ç½—åˆ—å‡º3ç§æœ€å¸¸è§çš„æƒ…å†µã€‚

1. location ä¸ºä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼Œæˆ– proxy_pass æŒ‡ä»¤ä½äºå‘½å location å†…
è¿™ç§æƒ…å†µä¸‹ï¼Œproxy_passçš„é…ç½®ä¸å…è®¸æŒ‡å®š uri éƒ¨åˆ†ã€‚

    æ¯”å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®

    ```nginx
    location ~ ^/novel/[^/]*mark-twain[^/]*/.+$ {
        proxy_pass http://novel-server;                  # â‘´
    }
    
    location @novel-authors {
        proxy_pass http://autor-server;                  # â‘µ
    }
    ```

    ä¸ä¸å¸¦ uri çš„ proxy_pass æŒ‡ä»¤ä¸€æ ·ï¼Œä¸Šé¢çš„é…ç½®ï¼Œæœ€ç»ˆå¾—åˆ°çš„è½¬å‘urlå°±æ˜¯ proxy_pass é…ç½®å†…å®¹ + è¯·æ±‚uri

    ä¸Šè¿°é…ç½®é‡Œâ‘´å’Œâ‘µå¤„çš„proxy_passæŒ‡ä»¤ï¼Œä¸å¯ä»¥åŒ…å«uriä¿¡æ¯ï¼Œå¦åˆ™å°†å¯¼è‡´é…ç½®æ–‡ä»¶è§£ææŠ¥é”™ã€‚å‡å¦‚â‘´å¤„çš„é…ç½®ä¸º    proxy_pass http://novel-server/; æˆ–proxy_pass http://novel-server/novels/;ï¼Œå¯åŠ¨nginxæ—¶ï¼Œå°†å¾—åˆ° ç±»ä¼¼ä¸‹é¢çš„é”™è¯¯ï¼š

    ```shell
    nginx: [emerg] "proxy_pass" cannot have URI part in location given by regular expression, or    inside named location, or inside "if" statement, or inside "limit_except" block in /usr/local/ nginx/conf/nginx.conf:89
    ```

    > è¿˜å¯ä»¥é€šè¿‡nginx -t -c é…ç½®æ–‡ä»¶è·¯å¾„å‘½ä»¤æ¥éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œé¿å…ç›´æ¥é‡å¯nginxæˆ–é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶

2. location ä¸­æœ‰ rewirte æŒ‡ä»¤ï¼Œå¹¶ä¸”è¯·æ±‚ uri åŒ¹é… rewrite çš„æ­£åˆ™è¡¨è¾¾å¼

    è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸå§‹è¯·æ±‚çš„uriä¼šè¢«rewirteæŒ‡ä»¤ä¿®æ”¹ï¼Œä¿®æ”¹åçš„uriï¼Œå°†ç›´æ¥ä¼ é€’ç»™proxy_passæŒ‡ä»¤ï¼Œè€Œproxy_pass æœ¬èº«çš„uriï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰å°†è¢«æ›¿æ¢ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

    ```nginx
    location /name/ {
        rewrite /name/([^/]+) /users?name=$1 break;
        proxy_passs http://user-center/main/basicinfo/;
    }
    ```

    å‡å¦‚è¯·æ±‚urlä¸º /name/jane-lotus, è¯¥uriä¸rewriteçš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯åŒ¹é…çš„ï¼Œå› æ­¤ï¼Œå¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š

    - åŸå§‹urlè¢«rewriteæŒ‡ä»¤ä¿®æ”¹ä¸ºï¼š/users?name=jane-lotus

    - ä¿®æ”¹åçš„urlä¼ é€’ç»™proxy_passæŒ‡ä»¤ï¼Œæ–°çš„è½¬å‘åœ°å€ä¸º http://user-center/users?name=jane-lotus å¯ä»¥çœ‹   åˆ°ï¼Œproxy_passä¸­çš„uriéƒ¨åˆ†ï¼Œå³/main/basicinfo/ï¼Œè¢«æ›¿æ¢æˆäº†/user?name=jane-lotus

    å¦‚æœè¯·æ±‚uriä¸º /name/regions/shuangliuï¼Œç”±äºå®ƒä¸åŒ¹é… rewrite æŒ‡ä»¤çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå› æ­¤ï¼Œproxy_pass çš„   è¡Œä¸ºå¤„äºæ­£å¸¸çŠ¶æ€ï¼ˆå³ä¸â€œé™„å¸¦æœ‰uriâ€æ—¶çš„è¡Œä¸ºä¸€è‡´ï¼‰ï¼Œæœ€åå¾—åˆ°çš„è½¬å‘åœ°å€ä¸º http://user-center/main/ basicinfo/regions/shuangliuï¼Œä¸åŒ…å« locationä¸­åŒ¹é…çš„ /name/ ã€‚

3. proxy_pass ä¸­ä½¿ç”¨äº†å˜é‡

åœ¨ä½¿ç”¨äº†å˜é‡çš„æƒ…å†µä¸‹ï¼Œå°†å˜é‡å†…å®¹æ›¿æ¢ä¸ºçœŸå®æ–‡æœ¬åå³ä¸ºæ–°çš„è½¬å‘åœ°å€ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```nginx
location /novel/ {
    proxy_passs http://book-server/books$request_uri;
}
```

å½“è¯·æ±‚uriä¸º/novel/three-body.html?page=3æ—¶ï¼Œæœ€ç»ˆçš„è½¬å‘åœ°å€ä¸ºhttp://book-server/books/novel/three-body.html?page=3 ã€‚æ˜¯ç›´æ¥æ›¿æ¢æ‰proxy_passsä¸­çš„$request_uriå˜é‡å¾—æ¥çš„ã€‚

# å°ç»“

é€šè¿‡ location æŒ‡ä»¤ï¼Œå¯å®ç°æ ¹æ®ä¸åŒè¯·æ±‚ uri è¿›è¡Œä¸åŒé…ç½®çš„æ•ˆæœï¼Œå› æ­¤å®ƒä¹Ÿæ›´åƒæ˜¯ http è¯·æ±‚è·¯ç”±ã€‚å¯åˆ†ä¸ºç²¾ç¡®åŒ¹é…ã€å‰ç¼€åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ã€‚

proxy_pass ç”¨äºå°†ä¸€ä¸ª location è¯·æ±‚ä»£ç†åˆ°å¦ä¸€ä¸ªæˆ–å¦ä¸€ç»„WebæœåŠ¡ï¼Œåœ¨ç”Ÿæˆæ–°çš„è½¬å‘åœ°å€æ—¶ï¼Œä¼šæ ¹æ® proxy_pass æ˜¯å¦å¸¦æœ‰uriè€Œæœ‰æ‰€ä¸åŒã€‚

æ€»çš„è¯´æ¥ï¼Œlocationä¸proxy_passï¼Œå¯¹å…¶é…ç½®æœ«å°¾çš„å­—ç¬¦æ˜¯å¦ä¸ºæ–œæ ï¼Œæ²¡æœ‰åšç‰¹æ®Šå¤„ç†ã€‚

**å‚è€ƒ** https://www.cnblogs.com/guzb/p/column-nginx-config_of_location_and_proxy_pass_and_the_difference_of_absence_of_tail_slash.html
